@page "/AcceptCookies"
@inject IJSRuntime JSRuntime
@inject Cineflex.Services.CookieService CookieService

@implements IAsyncDisposable

<div class="@(_showCookieBar ? "cookie-bar-visible" : "cookie-bar-hidden")">
    <div class="cookie-bar">
        <p>Deze website maakt gebruik van cookies om ervoor te zorgen dat u de beste ervaring op onze website krijgt.</p>
        <div class="cookie-content">
            <MudTooltip>
                <ChildContent>
                    <MudIconButton Icon="@Icons.Material.Filled.Help" />
                </ChildContent>
                <TooltipContent>
                    <MudText Typo="Typo.body2">
                        We gebruiken cookies om jouw voorkeuren op onze website op te slaan, zodat we je een betere ervaring kunnen bieden bij je volgende bezoek.
                    </MudText>
                </TooltipContent>
            </MudTooltip>
        </div>


        <div class="cookie-buttons">
            <button class="accept-button" @onclick="AcceptCookies_">Accept</button>
            <button class="reject-button" @onclick="RejectCookies">Reject</button>
        </div>
    </div>
</div>



@code {
    private bool _showCookieBar = false;
    private DotNetObjectReference<AcceptCookies>? _objRef;

    [Parameter] public EventCallback<bool> OnCookieDecisionMade { get; set; }


    // private bool _isFirstRender;

    protected override void OnInitialized()
    {
        // Initialize with the cookie bar hidden until we can check in the browser
        // _showCookieBar = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);

            await CheckCookieConsent();

            // _isFirstRender = false;
        }
    }

    private async Task CheckCookieConsent()
    {
        try
        {
            var hasConsent = await CookieService.CheckCookieConsent();
            if (hasConsent == null)
            {
                _showCookieBar = true;
            }
            else if (hasConsent == false)
            {
                _showCookieBar = true;
            }


            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking cookie consent: {ex.Message}");
            _showCookieBar = true;
            StateHasChanged();
        }
    }

    private async Task AcceptCookies_()
    {
        await CookieService.SetCookieConsent(true);
        _showCookieBar = false;
        await OnCookieDecisionMade.InvokeAsync(true);
        StateHasChanged();
    }

    private async Task RejectCookies()
    {
        await CookieService.SetCookieConsent(false);
        _showCookieBar = false;
        StateHasChanged();
    }

    public ValueTask DisposeAsync()
    {
        _objRef?.Dispose();
        return ValueTask.CompletedTask;
    }


    private async Task CheckConsentExist() 
    @* checkes only if the checkconsent exist in the localhost*@
    {
        var hasConsent = await CookieService.CheckCookieConsent();
        if (hasConsent == null)
        {
            _showCookieBar = true;
        }
        StateHasChanged();
        Console.WriteLine($"Cookie consent exists: {hasConsent}");
    }
}

<style>
    .cookie-bar-visible {
        position: fixed;
        bottom: 0;
        left: 50%;
        z-index: 1000;
        transition: transform 0.3s ease-in-out;
        transform: translate(-50%, 0);
    }

    .cookie-bar-hidden {
        position: fixed;
        bottom: 0;
        left: 50%;
        z-index: 1000;
        transition: transform 0.3s ease-in-out;
        transform: translate(-50%, 100%);
    }

    .cookie-bar {
        height: 50px;
        width: 1000px;
        background-color: #333;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
    }

    .cookie-content {
        flex: 1;
    }

    .cookie-buttons {
        display: flex;
        gap: 10px;
    }

    .accept-button, .reject-button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }

    .accept-button {
        background-color: #4CAF50;
        color: white;
    }

    .reject-button {
        background-color: #f44336;
        color: white;
    }

    .tooltip-behind {
        position: absolute;
        right: 150px;
        z-index: -1; /* Makes sure the tooltip goes behind the text */
    }

</style>