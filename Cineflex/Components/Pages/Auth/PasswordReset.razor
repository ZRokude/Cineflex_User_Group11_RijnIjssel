@page "/passwordreset/{Email}/{Token}"

@using Cineflex.Services.Email
@using Cinelexx.Services.Email
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@* @using Cineflex.Data
@using Cineflex.Data.Entities *@

@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@* @inject Cineflex DbContext *@
@rendermode InteractiveServer

<PageTitle>Reset Password</PageTitle>

<div class="@($"color-transition {backgroundClass}")" style="position: fixed; top: 0; left: 0; height: 100vh; width: 100vw; display: flex; justify-content: center; align-items: center; ">
    <MudCard Style="width: 450px; background-color:#2d1b1b; padding:15px; border-radius:15px;" Outlined="isValidToken">
        <!-- Logo container -->
        <div style="display: flex; justify-content: center; align-items: center; padding: 20px;">
            <MudImage Src="Picture/logo_covadis_2016.png" Style="height: 65px; width:225px" />
        </div>

        @if (isValidToken)
        {
            <MudCardContent>
                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
                    Voer je nieuwe wachtwoord in om het te wijzigen.
                </MudText>

                <!-- New Password Field -->
                <MudText Typo="Typo.body1" Color="Color.Primary" Class="mt-3">Wachtwoord:</MudText>
                <MudTextField T="string"
                              Label="Nieuw wachtwoord"
                              @bind-Value="model.NewPassword"
                              For="@(() => model.NewPassword)"
                              InputType="@NewPasswordInputType"
                              Required="true"
                              Variant="Variant.Filled"
                              Adornment="Adornment.End"
                              AdornmentIcon="@NewPasswordVisibilityIcon"
                              OnAdornmentClick="ToggleNewPasswordVisibility"
                              Pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{15,}"
                              Margin="Margin.Normal"
                              IconSize="Size.Medium"
                              Error="@(!string.IsNullOrEmpty(newPasswordError))"
                              ErrorText="@newPasswordError"
                              @onblur="ValidateNewPassword" />

                <!-- Password Strength Indicator -->
                @if (!string.IsNullOrEmpty(model.NewPassword))
                {
                    <div class="password-strength mt-2">
                        <MudText Typo="Typo.caption" Color="@GetPasswordStrengthColor()">
                            Wachtwoord sterkte: @GetPasswordStrengthText()
                        </MudText>
                        <MudProgressLinear Value="@GetPasswordStrengthPercentage()"
                                           Color="@GetPasswordStrengthColor()"
                                           Size="Size.Small"
                                           Class="mt-1" />
                    </div>
                }

                <!-- Confirm Password Field -->
                <MudText Typo="Typo.body1" Color="Color.Primary" Class="mt-3">Herhaal wachtwoord:</MudText>
                <MudTextField T="string"
                              Label="Wachtwoord herhalen"
                              @bind-Value="model.ConfirmPassword"
                              For="@(() => model.ConfirmPassword)"
                              InputType="@ConfirmPasswordInputType"
                              Required="true"
                              Variant="Variant.Filled"
                              Adornment="Adornment.End"
                              AdornmentIcon="@ConfirmPasswordVisibilityIcon"
                              OnAdornmentClick="ToggleConfirmPasswordVisibility"
                              Margin="Margin.Normal"
                              IconSize="Size.Medium"
                              Error="@(!string.IsNullOrEmpty(confirmPasswordError))"
                              ErrorText="@confirmPasswordError"
                              @onblur="ValidateConfirmPassword" />

                <!-- Password Requirements -->
                <div class="password-requirements mt-3">
                    <MudText Typo="Typo.caption" Color="Color.Primary">
                        Wachtwoord vereisten:
                    </MudText>
                    <div class="requirements-list">
                        <MudText Typo="Typo.caption" Color="@(HasMinLength() ? Color.Success : Color.Default)">
                            <MudIcon Icon="@(HasMinLength() ? Icons.Material.Filled.Check : Icons.Material.Filled.Close)" Size="Size.Small" />
                            Minimaal 15 karakters
                        </MudText>
                        <MudText Typo="Typo.caption" Color="@(HasUpperCase() ? Color.Success : Color.Default)">
                            <MudIcon Icon="@(HasUpperCase() ? Icons.Material.Filled.Check : Icons.Material.Filled.Close)" Size="Size.Small" />
                            Minimaal één hoofdletter
                        </MudText>
                        <MudText Typo="Typo.caption" Color="@(HasLowerCase() ? Color.Success : Color.Default)">
                            <MudIcon Icon="@(HasLowerCase() ? Icons.Material.Filled.Check : Icons.Material.Filled.Close)" Size="Size.Small" />
                            Minimaal één kleine letter
                        </MudText>
                        <MudText Typo="Typo.caption" Color="@(HasDigit() ? Color.Success : Color.Default)">
                            <MudIcon Icon="@(HasDigit() ? Icons.Material.Filled.Check : Icons.Material.Filled.Close)" Size="Size.Small" />
                            Minimaal één cijfer
                        </MudText>
                    </div>
                </div>

                <MudButton Color="Color.Primary"
                           Variant="Variant.Filled"
                           @onclick="ResetPassword"
                           FullWidth="true"
                           Disabled="@(!IsFormValid())"
                           Class="mt-4">
                    Wachtwoord veranderen
                </MudButton>
            </MudCardContent>
        }
        else
        {
            <MudPaper>
                <MudCardContent>
                    <MudText Typo="Typo.h6" Align="Align.Center" Color="Color.Error">
                        Ongeldige of verlopen resetlink.
                    </MudText>
                    <MudButton Color="Color.Primary"
                               Variant="Variant.Text"
                               @onclick="NavigateToLogin"
                               FullWidth="true"
                               Class="mt-3">
                        Terug naar login
                    </MudButton>
                </MudCardContent>
            </MudPaper>
        }
    </MudCard>
</div>

<style>
    .color-transition {
        transition: background-color 2s ease;
    }

    .start-color {
        background-color: #0f132f;
    }

    .end-color {
        background-color: #8b0000;
    }

    .password-requirements {
        background-color: rgba(255, 255, 255, 0.05);
        padding: 10px;
        border-radius: 5px;
    }

    .requirements-list .mud-text {
        display: flex;
        align-items: center;
        gap: 5px;
        margin: 2px 0;
    }

    .password-strength {
        background-color: rgba(255, 255, 255, 0.05);
        padding: 8px;
        border-radius: 5px;
    }
</style>

